!function(t){var e={};function a(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.m=t,a.c=e,a.d=function(t,e,i){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)a.d(i,n,function(e){return t[e]}.bind(null,n));return i},a.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="/build/plugins/",a(a.s=1)}([,function(t,e,a){"use strict";a.r(e);function i(t,e){return document.createElement("canvas").getContext("2d").createImageData(t,e)}function n(t,e,a){let n=function(t,e,a){let i=t.length;for(let n=0;n<i;n+=4){let i=e(t[n],t[n+1],t[n+2],a);t[n]=i[0],t[n+1]=i[1],t[n+2]=i[2],t[n+3]=i[3]}return t}(new Uint8ClampedArray(t.data),e,a),r=i(t.width,t.height);return r.data.set(n),r}function r(t){return n(t,s)}function s(t,e,a){let i=.3*t+.59*e+.11*a;return[i,i,i,255]}function l(t,e){return n(t,o,e)}function o(t,e,a,i){let n=-1*i,r=Math.max(t,e,a),s=t+e+a/3,l=2*Math.abs(r-s)/255*n/100;return[t!==r?t+(r-t)*l:t,e!==r?e+(r-e)*l:e,a!==r?a+(r-a)*l:a,255]}function h(t,e){return n(t,c,e)}function c(t,e,a,i){let n=Math.floor(i/100*255);return[t+n,e+n,a+n,255]}function d(t,e){return n(t,u,e)}function u(t,e,a,i){let n=Math.pow((i+100)/100,2),r=t,s=e,l=a;return r/=255,r-=.5,r*=n,r+=.5,s/=255,s-=.5,s*=n,s+=.5,l/=255,l-=.5,l*=n,l+=.5,[r*=255,s*=255,l*=255,255]}function p(t){return n(t,m)}function m(t,e,a){return[255-t,255-e,255-a,255]}function g(t,e){return n(t,_,e)}function _(t,e,a,i){let n=.2126*t+.7152*e+.0722*a>=i?255:0;return[n,n,n,255]}function v(t,e){return n(t,b,e)}function b(t,e,a,i){let{h:n,s:r,v:s}=function(t,e,a){let i=t,n=e,r=a;i/=255,n/=255,r/=255;let s,l=Math.max(i,n,r),o=Math.min(i,n,r),h=l,c=l-o,d=0===l?0:c/l;if(l===o)s=0;else{switch(l){case i:s=(n-r)/c+(n<r?6:0);break;case n:s=(r-i)/c+2;break;case r:s=(i-n)/c+4}s/=6}return{h:s,s:d,v:h}}(t,e,a);n*=100,n+=Math.abs(i),n%=100;let l=function(t,e,a){let i,n,r,s,l,o,h,c;switch(s=Math.floor(6*t),l=a*(1-e),o=a*(1-(n=6*t-s)*e),c=a*(1-(1-n)*e),s%6){case 0:h=a,r=c,i=l;break;case 1:h=o,r=a,i=l;break;case 2:h=l,r=a,i=c;break;case 3:h=l,r=o,i=a;break;case 4:h=c,r=l,i=a;break;case 5:h=a,r=l,i=o}return{r:Math.floor(255*h),g:Math.floor(255*r),b:Math.floor(255*i)}}(n/=100,r,s);return[l.r,l.g,l.b,255]}function f(t,e){let a=e||100;return function(t,e,a){let n=Math.round(Math.sqrt(e.length)),r=Math.floor(n/2),s=t.data,l=t.width,o=t.height,h=l,c=o,d=i(h,c),u=d.data,p=a?1:0;for(let t=0;t<c;t++)for(let a=0;a<h;a++){let i=t,c=a,d=4*(t*h+a),m=0,g=0,_=0,v=0;for(let t=0;t<n;t++)for(let a=0;a<n;a++){let h=i+t-r,d=c+a-r;if(h>=0&&h<o&&d>=0&&d<l){let i=4*(h*l+d),r=e[t*n+a];m+=s[i]*r,g+=s[i+1]*r,_+=s[i+2]*r,v+=s[i+3]*r}}u[d]=m,u[d+1]=g,u[d+2]=_,u[d+3]=v+p*(255-v)}return d}(t,[0,-(a/=100),0,-a,4*a+1,-a,0,-a,0])}function w(t,e,a){let i;return function(){let n=this,r=arguments,s=a&&!i;clearTimeout(i),i=setTimeout(function(){i=null,a||t.apply(n,r)},e),s&&t.apply(n,r)}}a.d(e,"default",function(){return A});class A{constructor(t){this._core=t,this.pageToolsIcon=this.createIcon(),this._backdrop=null,this._page=null,this._mainImage=null,this._canvas=null,this._filters={brightness:null,contrast:null},this._originalData=null,this.boundEscapeListener=this.escapeListener.bind(this)}handleClick(t,e,a,i){document.body.style.overflow="hidden",this._backdrop=document.createElement("div"),this._backdrop.classList.add("manipulation-fullscreen"),this._sidebar=document.createElement("div"),this._sidebar.classList.add("manipulation-sidebar"),this._mainArea=document.createElement("div"),this._mainArea.classList.add("manipulation-main-area"),this._tools=document.createElement("div"),this._tools.classList.add("manipulation-tools"),this._backdrop.appendChild(this._sidebar),this._backdrop.appendChild(this._mainArea),this._backdrop.appendChild(this._tools),this._core.parentObject.appendChild(this._backdrop),document.addEventListener("keyup",this.boundEscapeListener),this._page=e.manifest.pages[i],this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._mainArea.appendChild(this._canvas),this._initializeSidebar(),this._initializeTools()}createIcon(){const t=document.createElement("div");t.classList.add("diva-manipulation-icon");let e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("x","0px"),e.setAttribute("y","0px"),e.setAttribute("viewBox","0 0 25 25"),e.id=`${this._core.settings.selector}manipulation-icon`;let a=document.createElementNS("http://www.w3.org/2000/svg","g");a.id=`${this._core.settings.selector}manipulation-icon-glyph`,a.setAttribute("transform","matrix(1, 0, 0, 1, -11.5, -11.5)"),a.setAttribute("class","diva-pagetool-icon");let i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttribute("d","M27,21h-1v-9h-3v9h-1c-0.55,0-1,0.45-1,1v3c0,0.55,0.45,1,1,1h1h3h1c0.55,0,1-0.45,1-1v-3C28,21.45,27.55,21,27,21z M27,24h-5v-0.5h5V24z");let n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d","M35,16h-1v-4h-3v4h-1c-0.55,0-1,0.45-1,1v3c0,0.55,0.45,1,1,1h1h3h1c0.55,0,1-0.45,1-1v-3C36,16.45,35.55,16,35,16z M35,19h-5v-0.5h5V19z");let r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("d","M19,26h-1V12h-3v14h-1c-0.55,0-1,0.45-1,1v3c0,0.55,0.45,1,1,1h1h3h1c0.55,0,1-0.45,1-1v-3C20,26.45,19.55,26,19,26zM19,29h-5v-0.5h5V29z");let s=document.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("x","23"),s.setAttribute("y","27"),s.setAttribute("width","3"),s.setAttribute("height","9");let l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttribute("x","31"),l.setAttribute("y","22"),l.setAttribute("width","3"),l.setAttribute("height","14");let o=document.createElementNS("http://www.w3.org/2000/svg","rect");return o.setAttribute("x","15"),o.setAttribute("y","32"),o.setAttribute("width","3"),o.setAttribute("height","4"),a.appendChild(i),a.appendChild(n),a.appendChild(s),a.appendChild(r),a.appendChild(l),a.appendChild(o),e.appendChild(a),t.appendChild(e),t}escapeListener(t){27===t.keyCode&&(document.removeEventListener("keyup",this.boundEscapeListener),document.body.style.overflow="auto",this._core.parentObject.removeChild(this._backdrop))}_initializeSidebar(){let t=`${this._page.url}full/150,/0/default.jpg`,e=this._page.otherImages.map(t=>`${t.url}full/150,/0/default.jpg`),a=document.createElement("div");a.classList.add("manipulation-sidebar-primary-image");let i=document.createElement("img");i.setAttribute("src",t);let n=document.createElement("div");n.textContent=this._page.il,a.appendChild(i),a.appendChild(n),this._sidebar.appendChild(a),a.addEventListener("click",()=>{this._loadImageInMainArea.call(this,event,this._page.url)}),e.map((t,e)=>{let a=document.createElement("div");a.classList.add("manipulation-sidebar-secondary-image");let i=document.createElement("img");i.setAttribute("src",t);let n=document.createElement("div");n.textContent=this._page.otherImages[e].il,a.appendChild(i),a.appendChild(n),this._sidebar.appendChild(a),a.addEventListener("click",()=>this._loadImageInMainArea.call(this,event,this._page.otherImages[e].url))})}_initializeTools(){let t=document.createElement("div"),e=document.createElement("button");e.textContent="Grayscale",e.addEventListener("click",t=>this._applyTransformationToImageData(t,r)),t.appendChild(e);let a=document.createElement("div"),i=document.createElement("input");i.setAttribute("type","range"),i.setAttribute("max",100),i.setAttribute("min",-100),i.setAttribute("value",0),i.addEventListener("change",w(t=>this._applyTransformationToImageData(t,l,t.target.value),250)),a.appendChild(i);let n=document.createElement("div"),s=document.createElement("input");s.setAttribute("type","range"),s.setAttribute("max",100),s.setAttribute("min",-100),s.setAttribute("value",0),s.addEventListener("change",w(t=>this._applyTransformationToImageData(t,h,t.target.value),250)),n.appendChild(s);let o=document.createElement("div"),c=document.createElement("input");c.setAttribute("type","range"),c.setAttribute("max",100),c.setAttribute("min",-100),c.setAttribute("value",0),c.addEventListener("change",w(t=>this._applyTransformationToImageData(t,d,t.target.value),250)),o.appendChild(c);let u=document.createElement("div"),m=document.createElement("button");m.textContent="Invert Colours",m.addEventListener("click",t=>this._applyTransformationToImageData(t,p)),u.appendChild(m);let _=document.createElement("div"),b=document.createElement("input");b.setAttribute("type","range"),b.setAttribute("max",255),b.setAttribute("min",64),b.setAttribute("value",0),b.addEventListener("change",w(t=>this._applyTransformationToImageData(t,g,t.target.value),250)),_.appendChild(b);let A=document.createElement("div"),E=document.createElement("input");E.setAttribute("type","range"),E.setAttribute("max",100),E.setAttribute("min",0),E.setAttribute("value",0),E.addEventListener("change",w(t=>this._applyConvolutionFilter(t,f,t.target.value),250)),A.appendChild(E);let C=document.createElement("div"),y=document.createElement("input");y.setAttribute("type","range"),y.setAttribute("max",100),y.setAttribute("min",0),y.setAttribute("value",0),y.addEventListener("change",w(t=>this._applyConvolutionFilter(t,v,t.target.value),250)),C.appendChild(y),this._tools.appendChild(t),this._tools.appendChild(u),this._tools.appendChild(a),this._tools.appendChild(n),this._tools.appendChild(o),this._tools.appendChild(_),this._tools.appendChild(A),this._tools.appendChild(C)}_loadImageInMainArea(t,e){let a=`${e}full/full/0/default.jpg`;this._mainImage=new Image,this._mainImage.crossOrigin="anonymous",this._mainImage.addEventListener("load",()=>{this._canvas.size=Math.sqrt(this._mainImage.width*this._mainImage.width+this._mainImage.height*this._mainImage.height),this._canvas.width=this._mainImage.width,this._canvas.height=this._mainImage.height,this._canvas.cornerX=(this._canvas.size-this._mainImage.width)/2,this._canvas.cornerY=(this._canvas.size-this._mainImage.height)/2,this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._ctx.drawImage(this._mainImage,0,0,this._canvas.width,this._canvas.height),this._originalData=this._ctx.getImageData(0,0,this._canvas.width,this._canvas.height),this._mainImage=null}),this._mainImage.src=a}_applyTransformationToImageData(t,e,a){let i,n=this._canvas.width,r=this._canvas.height;a&&(i=parseInt(a,10));let s=e(this._originalData,i);this._ctx.clearRect(0,0,n,r),this._ctx.putImageData(s,0,0)}_applyConvolutionFilter(t,e,a){let i,n=this._canvas.width,r=this._canvas.height;a&&(i=parseInt(a,10));let s=e(this._originalData,i);this._ctx.clearRect(0,0,n,r),this._ctx.putImageData(s,0,0)}}A.prototype.pluginName="manipulation",A.prototype.isPageTool=!0,window.Diva.ManipulationPlugin=A}]);
//# sourceMappingURL=manipulation.js.map